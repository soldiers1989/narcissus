<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ih2ome.watermeter.dao.WatermeterMapper">
    <!-- 数据库表名 -->
    <sql id="smart_watermeter">narcissus.smart_watermeter</sql>
    <sql id="smart_gateway_bind">narcissus.smart_gateway_bind</sql>
    <sql id="smart_gateway">narcissus.smart_gateway</sql>
    <sql id="smart_watermeter_record">narcissus.smart_watermeter_record</sql>
    <sql id="smart_exception">narcissus.smart_mistake</sql>
    <sql id="house">caspain_test.house</sql>
    <sql id="room">caspain_test.room</sql>
    <sql id="apartment">volga_test.apartment</sql>
    <sql id="floor">volga_test.floor</sql>
    <sql id="jzroom">volga_test.room</sql>

    <!--配置一个resultMap -->
    <resultMap type="com.ih2ome.watermeter.vo.ApartmentVO" id="apartmentResultMap" autoMapping="true">
        <id column="id" property="id" />

        <collection property="floorVOS" javaType="List"
                    ofType="com.ih2ome.watermeter.vo.FloorVO" autoMapping="true">
            <id column="floor_id" property="floorId" />
        </collection>
    </resultMap>

<!--增 -->

    <!--添加水表-->
    <insert id="addSmartWatermeter" parameterType="com.ih2ome.hardware_service.service.model.narcissus.SmartWatermeter" useGeneratedKeys="true" keyProperty="smart_watermeter_id">
        insert into <include refid="smart_watermeter" />(created_at,created_by,updated_at,updated_by,deleted_at,deleted_by,apartment_id,floor_id,house_id,room_id,house_catalog,meter_type,
        uuid,onoff_status,price,meter_amount,last_amount,meter_updated_at,manufactory)
        values(#{createdAt},#{createdBy},#{updatedAt},#{updatedBy},#{deletedAt},#{deletedBy},#{apartmentId},#{floorId},#{houseId},#{roomId},#{houseCatalog},#{meterType},
        #{uuid},#{onoffStatus},#{price},#{meterAmount},#{lastAmount},#{meterUpdatedAt},#{manufactory})
    </insert>

    <!--添加水表-->
    <insert id="addSmartGatewayBind" parameterType="com.ih2ome.hardware_service.service.model.narcissus.SmartGatewayBind" >
        insert into <include refid="smart_gateway_bind" />(smart_device_type,smart_gateway_id,smart_id)
        values(#{smartGatewayId},#{smartDeviceType},#{smartId})
    </insert>



<!-- 改 -->

    <!--改水费单价-->
    <update id="updataWaterPrice" parameterType="int" >
        UPDATE <include refid="smart_watermeter" /> SET price = #{price} WHERE smart_watermeter_id = #{watermeterId};
    </update>

    <!--更新水表抄表读数-->
    <update id="updataWaterLastAmount"  >
        UPDATE <include refid="smart_watermeter" /> SET last_amount=#{amount},meter_updated_at= FROM_UNIXTIME(#{time}/1000) WHERE uuid = #{uuid};
    </update>

<!-- 查 -->

    <!-- 分散式水表 -->
    <select id="findWatermetersByUserId" parameterType="int" resultType="com.ih2ome.watermeter.vo.WatermeterDetailVO" >
        SELECT gb.smart_gateway_id,w.smart_watermeter_id,r.name AS room_name,h.area+h.building_num+h.floor_num+h.house_num AS house_name,w.meter_type,w.created_at,w.last_amount,w.meter_amount,w.price,w.onoff_status,g.sn
        FROM
        <include refid="smart_watermeter" /> AS w
        INNER JOIN
        <include refid="smart_gateway_bind" /> AS gb
        ON w.smart_watermeter_id = gb.smart_id
        INNER JOIN
        <include refid="smart_gateway" /> AS g
        ON g.smart_gateway_id = gb.smart_gateway_id
        INNER JOIN
        <include refid="house" /> AS h
        ON w.house_id= h.id
        INNER JOIN
        <include refid="room" /> AS r
        ON  w.room_id= r.id AND h.id=r.house_id AND r.created_by_id = #{id} ;
    </select>

    <!-- 查询网关by网关id -->
    <select id="findGatewaybySmartGatewayId" parameterType="int" resultType="com.ih2ome.watermeter.vo.WatermeterGatewayDetailVO">
        SELECT g.smart_gateway_id,g.room_id,g.updated_at,g.created_at,g.brand FROM <include refid="smart_gateway" />  g WHERE smart_gateway_id =  #{id};
    </select>

    <!--查询水表by网关id-->
    <select id="findWatermeterByGatewayId" parameterType="int" resultType="com.ih2ome.watermeter.vo.WatermeterDetailVO">
        SELECT gb.smart_gateway_id,w.smart_watermeter_id,r.name AS room_name,h.area+h.building_num+h.floor_num+h.house_num AS house_name,w.meter_type,w.created_at,w.last_amount,w.meter_amount,w.price,w.onoff_status
        FROM
        <include refid="smart_watermeter" /> AS w
        INNER JOIN
        <include refid="smart_gateway_bind" /> AS gb
        ON w.smart_watermeter_id = gb.smart_id AND gb.smart_gateway_id = #{id}
        INNER JOIN
        <include refid="house" /> AS h
        ON w.house_id= h.id
        INNER JOIN
        <include refid="room" /> AS r
        ON  w.room_id= r.id AND h.id=r.house_id;
    </select>

    <!--查询公寓by用户id-->
    <select id="findApartmentByUserId" parameterType="int" resultMap="apartmentResultMap">
        SELECT a.id,a.`name`,COUNT(DISTINCT w.smart_watermeter_id) AS watermeter_num,sum(case w.onoff_status when 1 then 1 else 0 end) AS watermeter_onoff_num,f.id AS floor_id,f.`name` AS floor_name
        FROM <include refid="apartment"/> AS a,<include refid="floor"/> AS f,<include refid="smart_watermeter"/> AS w
        WHERE
        f.apartment_id = a.id
        AND w.apartment_id = a.id
        AND a.created_by = #{id};
    </select>

    <!--查询集中式水表列表by楼层id-->
    <select id="findWatermetersByFloorId" parameterType="int" resultType="com.ih2ome.watermeter.vo.JZWatermeterDetailVO">
        SELECT w.smart_watermeter_id,r.`name` AS room_name,w.meter_type,w.created_at,w.last_amount,w.meter_amount,w.price,w.onoff_status,g.smart_gateway_id
        FROM <include refid="smart_gateway_bind"/> AS g,<include refid="room"/> AS r,<include refid="smart_watermeter"/> AS w
        WHERE w.floor_id = #{floorId}
        AND w.smart_watermeter_id = g.smart_id AND w.room_id = r.id;
    </select>

    <!--查询集中式公寓下的网关by公寓id-->
    <select id="findGatewayByApartmentId" parameterType="int" resultType="com.ih2ome.watermeter.vo.JZWatermeterGatewayVO" >
        SELECT g.smart_gateway_id,g.onoff_status,COUNT(DISTINCT gb.smart_id) AS watermeter_num,sum(case w.onoff_status when 1 then 1 else 0 end) AS watermeter_onoff_num
        FROM <include refid="smart_watermeter"/> AS w
        INNER JOIN <include refid="smart_gateway_bind"/> AS gb
        ON w.smart_watermeter_id = gb.smart_id
        INNER JOIN <include refid="smart_gateway"/>  AS g
        ON g.smart_gateway_id = gb.smart_gateway_id
        WHERE g.apartment_id = #{id};
    </select>

    <!--查询水表抄表记录by水表id-->
    <select id="findWatermeterRecordByWatermeterId" parameterType="int" resultType="com.ih2ome.watermeter.model.SmartWatermeterRecord">
        SELECT wr.created_at,wr.device_amount,wr.smart_watermeter_id FROM <include refid="smart_watermeter_record"/> wr WHERE smart_watermeter_id = #{id} ORDER BY created_at DESC
    </select>

    <!--查询筛选水表抄表记录by起止时间-->
    <select id="findWatermeterRecordByWatermeterIdAndTime"  resultType="com.ih2ome.watermeter.model.SmartWatermeterRecord">
       SELECT wr.created_at,wr.device_amount,wr.smart_watermeter_id FROM <include refid="smart_watermeter_record"/> wr WHERE smart_watermeter_id = #{id} AND created_at between #{startTime} and #{endTime} ORDER BY created_at DESC
    </select>

    <!--查询分散式用户房源by用户id-->
    <select id="findHouseByUserId" parameterType="int" resultType="com.ih2ome.watermeter.vo.HouseVO">
        SELECT h.id,h.area,h.building_num,h.house_num FROM <include refid="house"/> h WHERE h.created_by_id= #{id}
    </select>

    <!--水表异常记录by水表id-->
    <select id="findWatermeterExceptionByWaterId" parameterType="int" resultType="com.ih2ome.watermeter.vo.ExceptionVO">
        SELECT e.created_at,e.exception_type FROM <include refid="smart_exception"/> e,<include refid="smart_watermeter"/> w WHERE e.uuid = w.uuid AND w.smart_watermeter_id = #{id}
    </select>

    <!--网关异常记录by网关id-->
    <select id="findWatermeterGatewayExceptionByGatewayId" parameterType="int" resultType="com.ih2ome.watermeter.vo.ExceptionVO">
        SELECT e.created_at,e.exception_type FROM <include refid="smart_exception"/> e,<include refid="smart_gateway"/> g WHERE e.uuid = g.uuid AND g.smart_gateway_id = #{id}
    </select>

    <!--查询水表抄表参数by水表id-->
    <select id="findWatermeterRecordParamsByWatermeterId" parameterType="int" resultType="com.ih2ome.watermeter.vo.WatermeterRecordParamsVo">
        SELECT watermeter.uuid,watermeter.manufactory FROM <include refid="smart_watermeter"/> watermeter WHERE watermeter.smart_watermeter_id = #{id}
    </select>

    <!--查询房源信息byhouseid-->
    <select id="findHouseByHouseId" parameterType="int" resultType="com.ih2ome.peony.watermeterInterface.vo.AddHomeVo">
        SELECT house.city,house.block AS zone,(house.address + house.area +house.building_num+house.unit_num+house.floor_num +house.house_num) AS location,
        house.area AS block,house.id AS home_id,house.area AS home_name,house.remark AS description
        FROM <include refid="house"/> house WHERE house.id = #{id}
    </select>

    <!--查询room信息byhouseid-->
    <select id="findRoomByHouseId" parameterType="int" resultType="com.ih2ome.watermeter.vo.AddRoomVO">
        SELECT room.id AS room_id,room.name AS room_name,room.room_desc AS room_description
        FROM <include refid="room"/> room WHERE room.house_id = #{id}
    </select>

    <!--查询房源信息byApartmentid-->
    <select id="findHouseByApartmentId" parameterType="int" resultType="com.ih2ome.peony.watermeterInterface.vo.AddHomeVo">
        SELECT apartment.city,apartment.block AS zone,(apartment.address + apartment.area) AS location,
        apartment.area AS block,apartment.id AS home_id,apartment.area AS home_name,apartment.remark AS description
        FROM <include refid="apartment"/> apartment WHERE apartment.id = #{id}
    </select>

    <!--查询room信息byApartmentId-->
    <select id="findRoomByApartmentId" parameterType="int" resultType="com.ih2ome.watermeter.vo.AddRoomVO">
        SELECT jzroom.id AS room_id,jzroom.name AS room_name,jzroom.room_desc AS room_description
        FROM <include refid="jzroom"/> jzroom WHERE jzroom.apartment_id = #{id}
    </select>

    <!--查询room信息byApartmentId-->
    <select id="findRoomByFloorId" parameterType="int" resultType="com.ih2ome.watermeter.vo.AddRoomVO">
        SELECT jzroom.id AS room_id,jzroom.name AS room_name,jzroom.room_desc AS room_description
        FROM <include refid="jzroom"/> jzroom WHERE jzroom.floor_id = #{id}
    </select>

    <!--查询floorIdByroomId-->
    <select id="findFloorIdByRoomId" parameterType="int" resultType="java.lang.Integer">
        SELECT jzroom.floor_id
        FROM <include refid="jzroom"/> jzroom WHERE jzroom.id = #{id}
    </select>



    <!--<select id="finWatermeterByRoomIds" parameterType="List" resultMap="watermeterDetailVO">
        SELECT g.smart_gateway_id FROM (SELECT
        w.smart_watermeter_id,r.`name`,w.meter_type,w.created_at,w.last_amount,w.price,w.onoff_status
        FROM
        narcissus.smart_watermeter w ,caspain_test.room r
        WHERE room_id IN
        <foreach item="item" index="index" collection="list"  open="(" separator="," close=")">
            #{item}
        </foreach>
        ) temp,narcissus.smart_gateway_bind g WHERE g.smart_device_type = temp.smart_watermeter_id;

    </select>
-->

    <!--<select id="findGatewayByApartmentIds" parameterType="int" resultType="com.ih2ome.watermeter.vo.JZWatermeterGatewayVO" >
        SELECT g.smart_gateway_id,g.onoff_status,COUNT(gb.smart_id) AS watermeter_num,w.onoff_status AS watermter_onoff_status
        FROM narcissus.smart_watermeter AS w
        INNER JOIN narcissus.smart_gateway_bind AS gb
        ON w.smart_watermeter_id = gb.smart_id
        INNER JOIN narcissus.smart_gateway  AS g
        ON g.apartment_id = #{id};
    </select>-->


</mapper>