<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ih2ome.hardware_service.service.dao.SmartLockDao">

    <resultMap type="com.ih2ome.sunflower.model.backup.HomeVO" id="dispersedResultMap" autoMapping="true">
        <id column="homeId" property="homeId"/>
        <result property="userId" column="userId"></result>
        <result property="homeName" column="homeName"></result>
        <result property="homeType" column="homeType"></result>

        <collection property="rooms" javaType="List"
                    ofType="com.ih2ome.sunflower.model.backup.RoomVO" autoMapping="true">
            <id column="roomId" property="roomId"/>
            <result property="homeId" column="homeId"></result>
            <result property="roomName" column="roomName"></result>
            <result property="roomAssociationStatus" column="roomAssociationStatus"></result>
            <result property="thirdRoomId" column="thirdRoomId"></result>
            <result property="dataType" column="dataType"></result>
        </collection>
    </resultMap>

    <resultMap type="com.ih2ome.sunflower.model.backup.HomeVO" id="concentrateResultMap" autoMapping="true">
        <id column="homeId" property="homeId"/>
        <result property="userId" column="userId"></result>
        <result property="homeName" column="homeName"></result>
        <result property="homeType" column="homeType"></result>

        <collection property="rooms" javaType="List"
                    ofType="com.ih2ome.sunflower.model.backup.RoomVO" autoMapping="true">
            <id column="roomId" property="roomId"/>
            <result property="homeId" column="homeId"></result>
            <result property="roomName" column="roomName"></result>
            <result property="roomAssociationStatus" column="roomAssociationStatus"></result>
            <result property="thirdRoomId" column="thirdRoomId"></result>
            <result property="dataType" column="dataType"></result>
        </collection>
    </resultMap>

    <!--insert-->
    <!--新增房间关联记录-->
    <insert id="addAssociation" parameterType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartHouseMappingVO"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO narcissus_test.smart_house_mapping (
        house_catalog,
        data_type,
        h2omeID,
        provider_code,
        threeID,
        STATUS
        )
        VALUES(#{houseCatalog},#{dataType},#{h2omeId},#{providerCode},#{threeId},1);
    </insert>

    <!--新增设备记录-->
    <insert id="addSmartDevice" parameterType="com.ih2ome.sunflower.entity.narcissus.SmartDeviceV2"
            useGeneratedKeys="true" keyProperty="smartDeviceId" keyColumn="smart_device_ID">
      INSERT INTO narcissus_test.smart_device_v2 (
        brand,
        connection_status,
        connection_status_update_time,
        created_at,
        created_by,
        house_catalog,
        manage_status,
        name,
        provider_code,
        public_zone_ID,
        room_ID,
        smart_device_type,
        threeID
    )
    VALUES(#{brand},#{connectionStatus},#{connectionStatusUpdateTime},now(),
    #{createdBy},#{houseCatalog},'0',#{name},#{providerCode},#{publicZoneId},#{roomId},#{smartDeviceType},#{threeId})
    </insert>
    <!--新增网关记录-->
    <insert id="addSmartGateway" parameterType="com.ih2ome.sunflower.entity.narcissus.SmartGatewayV2"
            useGeneratedKeys="true" keyProperty="smartGatewayId" keyColumn="smart_gateway_ID">
      INSERT INTO narcissus_test.smart_gateway_v2 (
        smart_gateway_ID,
        uuid,
        sn,
        mac,
        model,
        model_name,
        install_time,
        brand,
        versions
    )VALUES(#{smartGatewayId},#{uuid},#{sn},#{mac},#{model},#{modelName},#{installTime},#{brand},#{versions})
    </insert>

    <!--新增门锁记录-->
    <insert id="addSmartLock" parameterType="com.ih2ome.sunflower.entity.narcissus.SmartLock"
            useGeneratedKeys="true" keyProperty="smartLockId" keyColumn="smart_lock_ID">
     INSERT INTO narcissus_test.smart_lock (
        smart_lock_ID,
        sn,
        mac,
        model,
        model_name,
        power,
        power_refreshtime,
        onoff_time,
        lqi,
         lqi_refreshtime,
        bind_time,
        versions
)VALUES(#{smartLockId},#{sn},#{mac},#{model},#{modelName},#{power},#{powerRefreshtime},#{onoffTime},#{lqi},#{lqiRefreshtime},#{bindTime},#{versions});
    </insert>

    <!--新增网关和设备绑定记录-->
    <insert id="addSmartDeviceBind">
        INSERT INTO narcissus_test.smart_gateway_bind_v2 (
        smart_device_ID,
        smart_gateway_ID
        )VALUES(#{lockDeviceId},#{gatewayDeviceId})

    </insert>
    <!--新增密码记录-->
    <insert id="addSmartLockPassword" parameterType="com.ih2ome.sunflower.entity.narcissus.SmartLockPassword"
            useGeneratedKeys="true" keyProperty="smartLockPasswordId" keyColumn="smart_lock_password_ID">
        INSERT INTO narcissus_test.smart_lock_password (
            smart_lock_ID,
            provider_code,
            threeID,
            lock3ID,
            created_at,
            NAME,
            STATUS,
            pwd_type,
            valid_time_start,
            valid_time_end,
            PASSWORD,
            description,
            is_default,
            send_to_mobile
        )VALUES(#{smartLockId},#{providerCode},#{threeId},#{lock3Id},NOW(),#{name},#{status},#{pwdType},#{validTimeStart},#{validTimeEnd},#{password},#{description},#{isDefault},#{sendToMobile})
    </insert>

    <!--update-->
    <!--修改房间关联记录-->
    <update id="updateAssociation" parameterType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartHouseMappingVO">
       UPDATE narcissus_test.smart_house_mapping nshm
        SET nshm.`status` = '1',nshm.threeID=#{threeId}
        WHERE
        nshm.provider_code = #{providerCode}
        AND nshm.house_catalog = #{houseCatalog}
        AND nshm.data_type =#{dataType}
        AND nshm.h2omeID = #{h2omeId}
    </update>

    <!--房间(公共区域)取消关联(分散式,集中式)-->
    <update id="cancelAssociation" parameterType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartHouseMappingVO">
        UPDATE narcissus_test.smart_house_mapping nshm
        SET nshm.`status` = '2'
        WHERE
        nshm.provider_code = #{providerCode}
        AND nshm.house_catalog = #{houseCatalog}
        AND nshm.data_type =#{dataType}
        AND nshm.h2omeID = #{h2omeId}
        AND nshm.threeID=#{threeId}
    </update>

    <!--通过roomId删除该房间下的设备记录(修改字段)-->
    <update id="clearDevicesByRoomId">
        UPDATE narcissus_test.smart_device_v2
        SET manage_status = 1
        WHERE
            room_ID= #{roomId}
        AND house_catalog = #{type} AND provider_code=#{providerCode}
    </update>

    <!--通过publicZoneId删除该公共区域下的设备记录(修改字段)-->
    <update id="clearDevicesByPublicZoneId">
        UPDATE narcissus_test.smart_device_v2
        SET manage_status = 1
        WHERE
            public_zone_ID = #{publicZoneId}
        AND house_catalog =#{type}  AND provider_code=#{providerCode}
    </update>

    <!--select-->
    <!--查询房源信息(分散式)-->
    <select id="findDispersedHomes" parameterType="string" resultMap="dispersedResultMap">
       SELECT * FROM((
            SELECT
                cth.created_by_id AS userId,
                cth.id AS homeId,
                cth.area AS homeName,
                '1' AS homeType,
                ntpz.public_zone_ID AS roomId,
                ntpz.`name` AS roomName,
                nshm.`status` AS roomAssociationStatus,
                nshm.threeID AS thirdRoomId,
                '5' AS dataType
            FROM
                `caspain_test`.house cth
            LEFT JOIN narcissus_test.public_zone ntpz ON cth.id = ntpz.parent_ID
            LEFT JOIN narcissus_test.smart_house_mapping nshm ON nshm.h2omeID = ntpz.public_zone_ID
            AND nshm.data_type = 5
            AND nshm.house_catalog = 1 AND  nshm.status= 1
            WHERE
                ntpz.data_type = 3
            AND cth.created_by_id =#{userId}
        )
        UNION ALL
            (
                SELECT
                    cth.created_by_id AS userId,
                    cth.id AS homeId,
                    cth.area AS homeName,
                    '1' AS homeType,
                    ctr.id AS roomId,
                    ctr.`name` AS roomName,
                    nshm.`status` AS roomAssociationStatus,
                    nshm.threeID AS thirdRoomId,
                    '4' AS dataType
                FROM
                    `caspain_test`.house cth
                LEFT JOIN `caspain_test`.room ctr ON cth.id = ctr.house_id
                LEFT JOIN narcissus_test.smart_house_mapping nshm ON ctr.id = nshm.h2omeID
                AND nshm.data_type = 4
                AND nshm.house_catalog = 1 AND nshm.status= 1
                WHERE
                    cth.created_by_id=#{userId}
                ORDER BY thirdRoomId DESC LIMIT 99999999999
            )) AS allrecord

    </select>

    <!--查询房源信息(集中式)-->
    <select id="findConcentrateHomes" parameterType="string" resultMap="concentrateResultMap">
        SELECT * FROM((
            SELECT
                vta.created_by AS userId,
                vta.id AS homeId,
                vta.`name` AS homeName,
                '0' AS homeType,
                ntpz.public_zone_ID AS roomId,
                ntpz.`name` AS roomName,
                nshm.`status` AS roomAssociationStatus,
                nshm.threeID AS thirdRoomId,
                '5' AS dataType
            FROM
                `volga_test`.apartment vta
            LEFT JOIN narcissus_test.public_zone ntpz ON vta.id = ntpz.parent_ID
            LEFT JOIN narcissus_test.smart_house_mapping nshm ON nshm.h2omeID = ntpz.public_zone_ID
            AND nshm.data_type = 5
            AND nshm.house_catalog = 0 AND  nshm.status= 1
            WHERE
                ntpz.data_type = 1
            AND vta.created_by = #{userId}
        )
        UNION ALL
            (
                SELECT
                    vta.created_by AS userId,
                    vta.id AS homeId,
                    vta.`name` AS homeName,
                    '0' AS homeType,
                    vtr.id AS roomId,
                    vtr.`name` AS roomName,
                    nshm.`status` AS roomAssociationStatus,
                    nshm.threeID AS thirdRoomId,
                    '4' AS dataType
                FROM
                    `volga_test`.apartment vta
                LEFT JOIN `volga_test`.room vtr ON vta.id = vtr.apartment_id
                LEFT JOIN narcissus_test.smart_house_mapping nshm ON vtr.id = nshm.h2omeID
                AND nshm.data_type = 4
                AND nshm.house_catalog = 0 AND  nshm.status= 1
                WHERE
                    vta.created_by = #{userId}
                ORDER BY thirdRoomId DESC LIMIT 99999999999
            )) AS allrecord
    </select>

    <!--查询房源映射表记录-->
    <select id="findHouseMappingRecord"
            parameterType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartHouseMappingVO"
            resultType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartHouseMappingVO">
        SELECT
            house_catalog as houseCatalog,
            data_type as dataType,
            h2omeID as h2omeId,
            provider_code as providerCode,
            threeID as threeId,
            `status`
            FROM
                narcissus_test.smart_house_mapping nshm
            WHERE
                nshm.h2omeID = #{h2omeId}
            AND nshm.data_type = #{dataType}
            AND nshm.house_catalog = #{houseCatalog} AND nshm.provider_code=#{providerCode}
    </select>

    <!--根据公共区域查询房间映射记录(分散式)-->
    <select id="findDispersedRoomMappingByPublicZone"
            parameterType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartHouseMappingVO"
            resultType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartHouseMappingVO">
      SELECT
        nshm.data_type AS dataType,
        nshm.h2omeID AS h2omeId,
        nshm.house_catalog AS houseCatalog,
        nshm.provider_code AS providerCode,
        nshm.threeID AS threeId
        FROM
            narcissus_test.public_zone ntpz
        LEFT JOIN caspain_test.house cth ON ntpz.parent_ID = cth.id
        LEFT JOIN caspain_test.room ctr ON cth.id = ctr.house_id
        LEFT JOIN narcissus_test.smart_house_mapping nshm ON nshm.h2omeID = ctr.id
        WHERE
            ntpz.public_zone_ID = #{h2omeId}
        AND ntpz.data_type = 3
        AND nshm.data_type = 4
        AND nshm.house_catalog = 1
        AND nshm.provider_code = #{providerCode}
    </select>

    <!--根据公共区域查询房间映射记录(集中式)-->
    <select id="findConcentrateRoomMappingByPublicZone"
            parameterType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartHouseMappingVO"
            resultType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartHouseMappingVO">
       SELECT
        nshm.data_type AS dataType,
        nshm.h2omeID AS h2omeId,
        nshm.house_catalog as houseCatalog,
        nshm.provider_code as providerCode,
        nshm.threeID as threeId
        FROM
            narcissus_test.public_zone ntpz
        LEFT JOIN `volga_test`.apartment vta ON ntpz.parent_ID = vta.id
        LEFT JOIN `volga_test`.room vtr ON vta.id = vtr.apartment_id
        LEFT JOIN narcissus_test.smart_house_mapping nshm ON nshm.h2omeID = vtr.id
        WHERE
            ntpz.public_zone_ID = #{h2omeId}
        AND ntpz.data_type = 1
        AND nshm.data_type = 4
        AND nshm.house_catalog = 0
        AND nshm.provider_code = #{providerCode}
    </select>

    <!--根据房间ID查询公共区域ID(集中式)-->
    <select id="findDispersedPublicZoneByRoomId" parameterType="string" resultType="string">
        SELECT
        npz.public_zone_ID
        FROM
            caspain_test.room ctr
        LEFT JOIN caspain_test.house cth ON ctr.house_id = cth.id
        LEFT JOIN narcissus_test.public_zone npz ON cth.id = npz.parent_ID
        WHERE
            npz.data_type = 3
        AND ctr.id = #{roomId}
    </select>

    <!--根据房间ID查询公共区域ID(集中式)-->
    <select id="findConcentratePublicZoneByRoomId" parameterType="string" resultType="string">
        SELECT
        npz.public_zone_ID
        FROM
            `volga_test`.room vtr
        LEFT JOIN `volga_test`.apartment vta ON vtr.apartment_id = vta.id
        LEFT JOIN narcissus_test.public_zone npz ON vta.id=npz.parent_ID
        WHERE npz.data_type=1 AND vtr.id=#{roomId}
    </select>
</mapper>