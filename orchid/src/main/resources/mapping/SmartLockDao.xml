<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ih2ome.hardware_service.service.dao.SmartLockDao">

    <resultMap type="com.ih2ome.sunflower.model.backup.HomeVO" id="dispersedResultMap" autoMapping="true">
        <id column="homeId" property="homeId"/>
        <result property="userId" column="userId"></result>
        <result property="homeName" column="homeName"></result>
        <result property="homeType" column="homeType"></result>
        <collection property="rooms" javaType="List"
                    ofType="com.ih2ome.sunflower.model.backup.RoomVO" autoMapping="true">
            <id column="roomId" property="roomId"/>
            <result property="roomName" column="roomName"></result>
            <result property="roomAssociationStatus" column="roomAssociationStatus"></result>
            <result property="thirdRoomId" column="thirdRoomId"></result>
        </collection>
    </resultMap>

    <resultMap type="com.ih2ome.sunflower.model.backup.HomeVO" id="concentrateResultMap" autoMapping="true">
        <id column="homeId" property="homeId"/>
        <result property="userId" column="userId"></result>
        <result property="homeName" column="homeName"></result>
        <result property="homeType" column="homeType"></result>
        <collection property="rooms" javaType="List"
                    ofType="com.ih2ome.sunflower.model.backup.RoomVO" autoMapping="true">
            <id column="roomId" property="roomId"/>
            <result property="roomName" column="roomName"></result>
            <result property="roomAssociationStatus" column="roomAssociationStatus"></result>
            <result property="thirdRoomId" column="thirdRoomId"></result>
        </collection>
    </resultMap>

    <!--insert-->
    <!--新增房间关联记录-->
    <insert id="addAssociation" parameterType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartHouseMappingVO"
            useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO narcissus_test.smart_house_mapping (
        house_catalog,
        data_type,
        h2omeID,
        provider_code,
        threeID,
        STATUS
        )
        VALUES(#{houseCatalog},#{dataType},#{h2omeId},#{providerCode},#{threeId},1);
    </insert>

    <!--update-->
    <!--修改房间关联记录-->
    <update id="updateAssociation" parameterType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartHouseMappingVO">
       UPDATE narcissus_test.smart_house_mapping nshm
        SET nshm.`status` = '1',nshm.threeID=#{threeId}
        WHERE
        nshm.provider_code = #{providerCode}
        AND nshm.house_catalog = #{houseCatalog}
        AND nshm.data_type =#{dataType}
        AND nshm.h2omeID = #{h2omeId}
    </update>

    <!--房间取消关联(分散式,集中式)-->
    <update id="cancelAssociation" parameterType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartHouseMappingVO">
        UPDATE narcissus_test.smart_house_mapping nshm
        SET nshm.`status` = '2'
        WHERE
        nshm.provider_code = #{providerCode}
        AND nshm.house_catalog = #{houseCatalog}
        AND nshm.data_type =#{dataType}
        AND nshm.h2omeID = #{h2omeId}
        AND nshm.threeID=#{threeId}
    </update>


    <!--select-->
    <!--查询房源信息(分散式)-->
    <select id="findDispersedHomes" parameterType="string" resultMap="dispersedResultMap">
        SELECT
	cth.created_by_id AS userId,
	cth.id AS homeId,
	cth.area AS homeName,
	'1' AS homeType,
	ctr.id AS roomId,
	ctr.`name` AS roomName,
	nshm.threeID AS thirdRoomId,
	nshm.status AS roomAssociationStatus
    FROM
        caspain_test.house cth
    LEFT JOIN caspain_test.room ctr ON cth.id = ctr.house_id
    LEFT JOIN narcissus_test.smart_house_mapping nshm ON ctr.id=nshm.h2omeID AND nshm.data_type=4 AND nshm.house_catalog=1
    WHERE
	ctr.created_by_id = #{userId};
    </select>

    <!--查询房源信息(集中式)-->
    <select id="findConcentrateHomes" parameterType="string" resultMap="concentrateResultMap">
       SELECT
	vta.created_by AS userId,
	vta.id AS homeId,
	vta.`name` AS homeName,
	'0' AS homeType,
	vtr.id AS roomId,
	vtr.`name` AS roomName,
	nshm.`status` as roomAssociationStatus,
	nshm.threeID as thirdRoomId
    FROM
    `volga_test`.apartment vta
    LEFT JOIN `volga_test`.room vtr ON vta.id = vtr.apartment_id
    LEFT JOIN narcissus_test.smart_house_mapping nshm ON vtr.id=nshm.h2omeID AND nshm.data_type=4 and nshm.house_catalog=0
    WHERE
    vta.created_by =#{userId};
    </select>

    <!--查询房源映射表记录-->
    <select id="findHouseMappingRecord"
            parameterType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartHouseMappingVO"
            resultType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartHouseMappingVO">
        SELECT
            house_catalog as houseCatalog,
            data_type as dataType,
            h2omeID as h2omeId,
            provider_code as providerCode,
            threeID as threeId,
            `status`
            FROM
                narcissus_test.smart_house_mapping nshm
            WHERE
                nshm.h2omeID = #{h2omeId}
            AND nshm.data_type = #{dataType}
            AND nshm.house_catalog = #{houseCatalog} AND nshm.provider_code=#{providerCode}
    </select>
</mapper>