<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ih2ome.hardware_service.service.dao.SmartLockGatewayDao">

    <resultMap id="HadBindHouseMap" type="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartLockHadBindHouseVo" autoMapping="true">
        <id column="homeId" property="homeId"/>
        <result property="gatewayId" column="gatewayId"></result>
        <result property="homeName" column="homeName"></result>
        <collection property="roomAndPublicZoneVoList" javaType="List"
                    ofType="com.ih2ome.sunflower.vo.pageVo.smartLock.RoomAndPublicZoneVo" autoMapping="true">
            <id property="smartLockId" column="smartLockId"></id>
            <result column="roomNo" property="roomNo"></result>
            <result property="communicationStatus" column="communicationStatus"></result>
            <result property="powerRate" column="powerRate"></result>
        </collection>
    </resultMap>

    <!--SELECT-->

    <select id="getConcentrateGatewayModelByHomeId" resultType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartLockGatewayAndHouseInfoVO">
          SELECT
            nsgv2.smart_gateway_ID gatewayId,
            nsdv2.`name` gatewayCode,
            va.address houseAddress,
            nsdv2.connection_status connectionState,
            CONCAT(
            (
                    SELECT
                        count(*)
                    FROM
                        narcissus_test.smart_gateway_bind_v2 nsgbv2,
                        narcissus_test.smart_lock nsl,
                        narcissus_test.smart_device_v2 nsdv2l
                    WHERE
                        nsgbv2.smart_device_ID = nsl.smart_lock_ID
                    AND nsgbv2.smart_gateway_ID = nsgv2.smart_gateway_ID
                    AND nsdv2l.smart_device_ID = nsl.smart_lock_ID
                    AND nsdv2l.connection_status = '1'
                ),
                '/',
                (
                    SELECT
                        count(*)
                    FROM
                        narcissus_test.smart_gateway_bind_v2 nsgbv2,
                        narcissus_test.smart_lock nsl
                    WHERE
                        nsgbv2.smart_device_ID = nsl.smart_lock_ID
                    AND nsgbv2.smart_gateway_ID = nsgv2.smart_gateway_ID
                )
            ) bindOnlineDeviceCountPercentage
        FROM
            narcissus_test.smart_device_v2 nsdv2,
            narcissus_test.smart_gateway_v2 nsgv2,
            narcissus_test.public_zone npz,
            volga_test.apartment va
        WHERE
            nsgv2.smart_gateway_ID = nsdv2.smart_device_ID
        AND nsdv2.public_zone_ID = npz.public_zone_ID
        AND va.id = npz.parent_ID
        AND npz.data_type = '1'
        AND va.id = #{homeId}

    </select>

    <select id="getDispersedGatewayModelByHomeId" resultType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartLockGatewayAndHouseInfoVO">
        SELECT
            nsgv2.smart_gateway_ID gatewayId,
            nsdv2.`name` gatewayCode,
            ch.address houseAddress,
            nsdv2.connection_status connectionState,
            CONCAT(
                (
                    SELECT
                        count(*)
                    FROM
                        narcissus_test.smart_gateway_bind_v2 nsgbv2,
                        narcissus_test.smart_lock nsl,
                        narcissus_test.smart_device_v2 nsdv2l
                    WHERE
                        nsgbv2.smart_device_ID = nsl.smart_lock_ID
                    AND nsgbv2.smart_gateway_ID = nsgv2.smart_gateway_ID
                    AND nsdv2l.smart_device_ID = nsl.smart_lock_ID
                    AND nsdv2l.connection_status = '1'
                ),
                '/',
                (
                    SELECT
                        count(*)
                    FROM
                        narcissus_test.smart_gateway_bind_v2 nsgbv2,
                        narcissus_test.smart_lock nsl
                    WHERE
                        nsgbv2.smart_device_ID = nsl.smart_lock_ID
                    AND nsgbv2.smart_gateway_ID = nsgv2.smart_gateway_ID
                )
            ) bindOnlineDeviceCountPercentage
        FROM
            narcissus_test.smart_device_v2 nsdv2,
            narcissus_test.smart_gateway_v2 nsgv2,
            narcissus_test.public_zone npz,
            caspain_test.house ch
        WHERE
            nsgv2.smart_gateway_ID = nsdv2.smart_device_ID
        AND nsdv2.public_zone_ID = npz.public_zone_ID
        AND ch.id = npz.parent_ID
        AND npz.data_type = '1'
        AND ch.id = #{homeId}
    </select>

    <select id="getSmartLockHadBindGateway" resultType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartLockGatewayHadBindVO">
            SELECT
                nsg.smart_gateway_id gatewayId,
                nsg.uuid gatewayCode,
                nsg.`name` gatewayName,
                IFNULL(ch.area,va.`name`) houseName,
                IFNULL(ch.address,va.address) houseAddress
            FROM
                narcissus_test.smart_device_v2 nsdv2,
                narcissus_test.smart_gateway_v2 nsg,
                caspain_test.house ch,
                volga_test.apartment va
            WHERE
                nsg.smart_lock_ID = nsdv2.smart_device_ID
            AND nsg.smart_lock_ID=#{gatewayId}
            AND (
                nsdv2.house_ID = ch.id
                OR nsdv2.apartment_ID = va.id
            )
    </select>

    <select id="getSmartLockAndRoomListByGatewayId" resultType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartLockGatewayHadBindRoomVO">
        SELECT
            ntsl.smart_lock_ID smartLockId,
            IFNULL(cr.`name`,vr.`name`) roomNo,
            ntsl.power powerRate,
            nsdv2.connection_status communicationStatus
        FROM
            narcissus_test.smart_lock ntsl,
            narcissus_test.smart_gateway_bind_v2 nsgbv2,
            narcissus_test.smart_device_v2 nsdv2,
            caspain_test.room cr,
            volga_test.room vr
        WHERE
            nsgbv2.smart_device_ID = ntsl.smart_lock_ID
        AND (nsdv2.room_ID = cr.id or nsdv2.room_ID=vr.id)
        AND nsgbv2.smart_device_ID = nsdv2.smart_device_ID
        AND nsgbv2.smart_gateway_ID = #{gatewayId}
    </select>

    <select id="getSmartLockGatewayDetailInfo" resultType="com.ih2ome.sunflower.vo.pageVo.smartLock.SmartLockDetailVO">
        SELECT
            nsgv2.smart_gateway_ID gatewayId,
            nsdv2.`name` gatewayCode,
            nsgv2.install_time bindTime,
            nsdv2.connection_status_update_time updateTime,
            nsdv2.provider_code provider,
            nsgv2.versions versionJson
        FROM
            narcissus_test.smart_device_v2 nsdv2,
            narcissus_test.smart_gateway_v2 nsgv2
        WHERE
            nsdv2.smart_device_ID = nsgv2.smart_gateway_ID
        AND nsdv2.smart_device_ID = #{gatewayId}
        AND nsdv2.manage_status='0'
    </select>

    <select id="getDispersedHadBindHouseList" resultMap="HadBindHouseMap">
        SELECT
            va.id AS homeId,
            nsg.smart_gateway_ID AS gatewayId,
            va.address AS homeName,
            lockCon.roomNo AS roomNo,
            lockCon.smartLockId AS smartLockId,
            lockCon.communicationStatus AS communicationStatus,
            lockCon.powerRate AS powerRate
        FROM
            narcissus_test.smart_device_v2 nsdv2,
            narcissus_test.smart_gateway_v2 nsg,
            narcissus_test.public_zone npz,
            caspain_test.house va,
            caspain_test.auth_user cau,
            (
                (
                    SELECT
                        "公共区域" roomNo,
                        nslpublic.smart_lock_ID smartLockId,
                        nsdv2public.connection_status communicationStatus,
                        nsdv2public.work_status powerRate,
                        npzpublic.parent_ID parentId
                    FROM
                        narcissus_test.public_zone npzpublic,
                        narcissus_test.smart_lock nslpublic,
                        narcissus_test.smart_device_v2 nsdv2public
                    WHERE
                        nslpublic.smart_lock_ID = nsdv2public.smart_device_ID
                    AND nsdv2public.public_zone_ID = npzpublic.public_zone_ID
                    AND npzpublic.data_type = '1'
                )
                UNION
                    (
                        SELECT
                            nslprivate.smart_lock_ID smartLockId,
                            vr.`name` roomNo,
                            nsdv2private.connection_status communicationStatus,
                            nsdv2private.work_status powerRate,
                            vr.apartment_id parentId
                        FROM
                            narcissus_test.smart_lock nslprivate,
                            narcissus_test.smart_device_v2 nsdv2private,
                            volga_test.room vr
                        WHERE
                            nslprivate.smart_lock_ID = nsdv2private.smart_device_ID
                        AND nsdv2private.room_ID = vr.id
                    )
            ) lockCon
        WHERE
            nsdv2.smart_device_ID = nsg.smart_gateway_ID
        AND nsdv2.public_zone_ID = npz.public_zone_ID
        AND npz.parent_ID = va.id
        AND npz.data_type = '1'
        AND lockCon.parentId = va.id
        AND cau.id = va.created_by_id
        AND cau.id = #{userId}
    </select>

    <select id="getConcentrateHadBindHouseList" resultMap="HadBindHouseMap">
         SELECT
            va.id AS homeId,
            nsg.smart_gateway_ID AS gatewayId,
            va.address AS homeName,
            lockCon.roomNo AS roomNo,
            lockCon.smartLockId AS smartLockId,
            lockCon.communicationStatus AS communicationStatus,
            lockCon.powerRate AS powerRate
        FROM
            narcissus_test.smart_device_v2 nsdv2,
            narcissus_test.smart_gateway_v2 nsg,
            narcissus_test.public_zone npz,
            volga_test.apartment va,
            caspain_test.auth_user cau,
            (
                (
                    SELECT
                        "公共区域" roomNo,
                        nslpublic.smart_lock_ID smartLockId,
                        nsdv2public.connection_status communicationStatus,
                        nsdv2public.work_status powerRate,
                        npzpublic.parent_ID parentId
                    FROM
                        narcissus_test.public_zone npzpublic,
                        narcissus_test.smart_lock nslpublic,
                        narcissus_test.smart_device_v2 nsdv2public
                    WHERE
                        nslpublic.smart_lock_ID = nsdv2public.smart_device_ID
                    AND nsdv2public.public_zone_ID = npzpublic.public_zone_ID
                    AND npzpublic.data_type = '1'
                )
                UNION
                    (
                        SELECT
                            nslprivate.smart_lock_ID smartLockId,
                            vr.`name` roomNo,
                            nsdv2private.connection_status communicationStatus,
                            nsdv2private.work_status powerRate,
                            vr.apartment_id parentId
                        FROM
                            narcissus_test.smart_lock nslprivate,
                            narcissus_test.smart_device_v2 nsdv2private,
                            volga_test.room vr
                        WHERE
                            nslprivate.smart_lock_ID = nsdv2private.smart_device_ID
                        AND nsdv2private.room_ID = vr.id
                    )
            ) lockCon
        WHERE
            nsdv2.smart_device_ID = nsg.smart_gateway_ID
        AND nsdv2.public_zone_ID = npz.public_zone_ID
        AND npz.parent_ID = va.id
        AND npz.data_type = '1'
        AND lockCon.parentId = va.id
        AND cau.id = va.created_by
        AND cau.id = #{userId}
    </select>
</mapper>
